'use client'\n\nimport { useState, useEffect } from 'react'\nimport { createClientComponentClient } from '@supabase/auth-helpers-nextjs'\nimport { Plus, Edit, Trash2, Building2 } from 'lucide-react'\nimport Button from '@/components/ui/Button'\nimport Input from '@/components/ui/Input'\nimport Textarea from '@/components/ui/Textarea'\nimport { uploadMultipleFiles, deleteFile } from '@/lib/supabase/storage'\n\ninterface Development { \n  id: string\n  name: string\n  slug: string\n  description: string | null\n  neighborhood: string\n  city: string\n  state: string\n  price_from: number\n  units: number\n  status: string\n  delivery: string | null\n  image: string | null\n  developer_id: string | null\n  gallery_images: string[] | null\n  floor_plans: string[] | null\n  videos: string[] | null\n  created_at: string\n } \n\ninterface Developer { \n  id: string\n  name: string\n } \n\nexport default function DevelopmentsPage() { \n  const supabase = createClientComponentClient() \n  const [developments, setDevelopments] = useState<Development[]>([]) \n  const [developers, setDevelopers] = useState<Developer[]>([]) \n  const [isLoading, setIsLoading] = useState(true) \n  const [isModalOpen, setIsModalOpen] = useState(false) \n  const [editingDevelopment, setEditingDevelopment] = useState<Development | null>(null) \n  const [isUploading, setIsUploading] = useState(false) \n\n  const [formData, setFormData] = useState({ \n    name: '', \n    slug: '', \n    description: '', \n    neighborhood: '', \n    city: 'João Pessoa', \n    state: 'PB', \n    price_from: 0, \n    units: 0, \n    status: 'Lançamento', \n    delivery: '', \n    image: '', \n    developer_id: '', \n    gallery_images: [] as string[], \n    floor_plans: [] as string[], \n    videos: [] as string[]\n }) \n\n  useEffect(() => { \n    fetchDevelopments() \n    fetchDevelopers() \n }, []) \n\n  async function fetchDevelopments() { \n    const { data, error } = await supabase\n      .from('developments') \n.select('*') \n.order('created_at', { ascending: false }) \n\n    if (!error && data) { \n      setDevelopments(data) \n } \n    setIsLoading(false) \n } \n\n  async function fetchDevelopers() { \n    const { data, error } = await supabase\n      .from('developers') \n.select('id, name') \n.eq('active', true) \n.order('name') \n\n    if (!error && data) { \n      setDevelopers(data) \n } \n } \n\n  async function handleImageUpload(e: React.ChangeEvent<HTMLInputElement>) { \n    const file = e.target.files?.[0]\n    if (!file) return \n\n    setIsUploading(true) \n    const { urls } = await uploadMultipleFiles('developments', [file]) \n    \n    if (urls.length > 0) { \n      setFormData(prev => ({ ...prev, image: urls[0] })) \n } \n    setIsUploading(false) \n } \n\n  async function handleGalleryUpload(e: React.ChangeEvent<HTMLInputElement>) { \n    const files = e.target.files\n    if (!files || files.length === 0) return \n\n    setIsUploading(true) \n    const fileArray = Array.from(files) \n    const { urls } = await uploadMultipleFiles('developments', fileArray) \n    \n    if (urls.length > 0) { \n      setFormData(prev => ({ \n        ...prev, \n        gallery_images: [...prev.gallery_images, ...urls] \n })) \n } \n    setIsUploading(false) \n } \n\n  async function handleFloorPlansUpload(e: React.ChangeEvent<HTMLInputElement>) { \n    const files = e.target.files\n    if (!files || files.length === 0) return \n\n    setIsUploading(true) \n    const fileArray = Array.from(files) \n    const { urls } = await uploadMultipleFiles('developments', fileArray) \n    \n    if (urls.length > 0) { \n      setFormData(prev => ({ \n        ...prev, \n        floor_plans: [...prev.floor_plans, ...urls] \n })) \n } \n    setIsUploading(false) \n } \n\n  async function handleSubmit(e: React.FormEvent) { \n    e.preventDefault() \n\n    const payload = { \n      ...formData, \n      developer_id: formData.developer_id || null, \n      delivery: formData.delivery || null, \n      slug: formData.slug || formData.name.toLowerCase().replace(/\\s+/g, '-') \n }\n\n    if (editingDevelopment) { \n      await supabase\n.from('developments') \n.update(payload) \n.eq('id', editingDevelopment.id) \n } else { \n      await supabase\n.from('developments') \n.insert([payload]) \n } \n\n    setIsModalOpen(false) \n    resetForm() \n    fetchDevelopments() \n } \n\n  async function handleDelete(id: string, image: string | null, gallery: string[] | null, plans: string[] | null) { \n    if (!confirm('Tem certeza que deseja excluir este imóvel?')) return \n\n    const allUrls = [image, ...(gallery || []), ...(plans || [])].filter(Boolean) as string[]\n    \n    for (const url of allUrls) { \n      const path = url.split('/').pop() \n      if (path) await deleteFile('developments', path) \n } \n\n    await supabase\n.from('developments') \n.delete() \n.eq('id', id) \n\n    fetchDevelopments() \n } \n\n  function openEditModal(development: Development) { \n    setEditingDevelopment(development) \n    setFormData({ \n      name: development.name, \n      slug: development.slug, \n      description: development.description || '', \n      neighborhood: development.neighborhood, \n      city: development.city, \n      state: development.state, \n      price_from: development.price_from, \n      units: development.units, \n      status: development.status, \n      delivery: development.delivery || '', \n      image: development.image || '', \n      developer_id: development.developer_id || '', \n      gallery_images: development.gallery_images || [], \n      floor_plans: development.floor_plans || [], \n      videos: development.videos || []\n }) \n    setIsModalOpen(true) \n } \n\n  function resetForm() { \n    setFormData({ \n      name: '', \n      slug: '', \n      description: '', \n      neighborhood: '', \n      city: 'João Pessoa', \n      state: 'PB', \n      price_from: 0, \n      units: 0, \n      status: 'Lançamento', \n      delivery: '', \n      image: '', \n      developer_id: '', \n      gallery_images: [], \n      floor_plans: [], \n      videos: []\n }) \n    setEditingDevelopment(null) \n } \n\n  function removeGalleryImage(index: number) { \n    setFormData(prev => ({ \n      ...prev, \n      gallery_images: prev.gallery_images.filter((_, i) => i !== index) \n })) \n } \n\n  function removeFloorPlan(index: number) { \n    setFormData(prev => ({ \n      ...prev, \n      floor_plans: prev.floor_plans.filter((_, i) => i !== index) \n })) \n } \n\n  if (isLoading) { \n    return <div className=\"p-8\">Carregando...</div>\n  }\n\n  return (\n    <div className=\"p-8\">\n      <div className=\"flex items-center justify-between mb-8\">\n        <h1 className=\"text-3xl font-bold text-navy-900\">Imóveis</h1>\n        <Button onClick={() => setIsModalOpen(true)}>\n          <Plus className=\"w-5 h-5 mr-2\" />\n          Novo Imóvel\n        </Button>\n      </div>\n\n      <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {developments.map((dev) => (\n          <div key={dev.id} className=\"bg-white rounded-xl overflow-hidden border border-slate-200\">\n            {dev.image ? (\n              <img src={dev.image} alt={dev.name} className=\"w-full h-48 object-cover\" />\n            ) : (\n              <div className=\"w-full h-48 bg-slate-100 flex items-center justify-center\">\n                <Building2 className=\"w-12 h-12 text-slate-400\" />\n              </div>\n            )}\n            <div className=\"p-6\">\n              <h3 className=\"text-xl font-bold text-navy-900 mb-2\">{dev.name}</h3>\n              <p className=\"text-sm text-slate-600 mb-2\">{dev.neighborhood}, {dev.city}</p>\n              <p className=\"text-lg font-bold text-navy-900 mb-4\">\n                A partir de {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0 }).format(dev.price_from)}\n              </p>\n              <div className=\"flex gap-2\">\n                <Button size=\"sm\" variant=\"outline\" onClick={() => openEditModal(dev)}>\n                  <Edit className=\"w-4 h-4\" />\n                </Button>\n                <Button \n                  size=\"sm\" \n                  variant=\"outline\" \n                  onClick={() => handleDelete(dev.id, dev.image, dev.gallery_images, dev.floor_plans)}\n                >\n                  <Trash2 className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {isModalOpen && (\n        <div className=\"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4\">\n          <div className=\"bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-8\">\n            <h2 className=\"text-2xl font-bold text-navy-900 mb-6\">\n              {editingDevelopment ? 'Editar Imóvel' : 'Novo Imóvel'}\n            </h2>\n\n            <form onSubmit={handleSubmit} className=\"space-y-6\">\n              <Input\n                label=\"Nome do Empreendimento\"\n                value={formData.name}\n                onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                required\n              />\n\n              <div>\n                <label className=\"block text-sm font-semibold text-navy-900 mb-2\">\n                  Construtora\n                </label>\n                <select\n                  value={formData.developer_id}\n                  onChange={(e) => setFormData(prev => ({ ...prev, developer_id: e.target.value }))}\n                  className=\"w-full h-11 px-4 rounded-lg border border-slate-200\"\n                >\n                  <option value=\"\">Selecione uma construtora</option>\n                  {developers.map(dev => (\n                    <option key={dev.id} value={dev.id}>{dev.name}</option>\n                  ))}\n                </select>\n              </div>\n\n              <Textarea\n                label=\"Descrição\"\n                value={formData.description}\n                onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\n                rows={4}\n              />\n\n              <div className=\"grid md:grid-cols-3 gap-4\">\n                <Input\n                  label=\"Bairro\"\n                  value={formData.neighborhood}\n                  onChange={(e) => setFormData(prev => ({ ...prev, neighborhood: e.target.value }))}\n                  required\n                />\n                <Input\n                  label=\"Cidade\"\n                  value={formData.city}\n                  onChange={(e) => setFormData(prev => ({ ...prev, city: e.target.value }))}\n                  required\n                />\n                <Input\n                  label=\"Estado\"\n                  value={formData.state}\n                  onChange={(e) => setFormData(prev => ({ ...prev, state: e.target.value }))}\n                  required\n                />\n              </div>\n\n              <div className=\"grid md:grid-cols-2 gap-4\">\n                <Input\n                  label=\"Preço a partir de\"\n                  type=\"number\"\n                  value={formData.price_from}\n                  onChange={(e) => setFormData(prev => ({ ...prev, price_from: Number(e.target.value) }))}\n                  required\n                />\n                <Input\n                  label=\"Número de Unidades\"\n                  type=\"number\"\n                  value={formData.units}\n                  onChange={(e) => setFormData(prev => ({ ...prev, units: Number(e.target.value) }))}\n                  required\n                />\n              </div>\n\n              <div className=\"grid md:grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-semibold text-navy-900 mb-2\">\n                    Status\n                  </label>\n                  <select\n                    value={formData.status}\n                    onChange={(e) => setFormData(prev => ({ ...prev, status: e.target.value }))}\n                    className=\"w-full h-11 px-4 rounded-lg border border-slate-200\"\n                  >\n                    <option value=\"Lançamento\">Lançamento</option>\n                    <option value=\"Em Obras\">Em Obras</option>\n                    <option value=\"Pronto\">Pronto</option>\n                    <option value=\"Entregue\">Entregue</option>\n                  </select>\n                </div>\n                <Input\n                  label=\"Previsão de Entrega\"\n                  value={formData.delivery}\n                  onChange={(e) => setFormData(prev => ({ ...prev, delivery: e.target.value }))}\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-navy-900 mb-2\">\n                  Imagem Principal\n                </label>\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  onChange={handleImageUpload}\n                  disabled={isUploading}\n                  className=\"w-full\"\n                />\n                {formData.image && (\n                  <img src={formData.image} alt=\"Preview\" className=\"mt-4 h-32 object-cover rounded\" />\n                )}\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-navy-900 mb-2\">\n                  Galeria de Imagens\n                </label>\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  multiple\n                  onChange={handleGalleryUpload}\n                  disabled={isUploading}\n                  className=\"w-full\"\n                />\n                {isUploading && <p className=\"text-sm text-slate-600 mt-2\">Enviando...</p>}\n                {formData.gallery_images.length > 0 && (\n                  <div className=\"grid grid-cols-4 gap-4 mt-4\">\n                    {formData.gallery_images.map((url, i) => (\n                      <div key={i} className=\"relative\">\n                        <img src={url} alt=\"Gallery\" className=\"w-full h-24 object-cover rounded\" />\n                        <button\n                          type=\"button\"\n                          onClick={() => removeGalleryImage(i)}\n                          className=\"absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs\"\n                        >\n                          ×\n                        </button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-semibold text-navy-900 mb-2\">\n                  Plantas\n                </label>\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  multiple\n                  onChange={handleFloorPlansUpload}\n                  disabled={isUploading}\n                  className=\"w-full\"\n                />\n                {formData.floor_plans.length > 0 && (\n                  <div className=\"grid grid-cols-4 gap-4 mt-4\">\n                    {formData.floor_plans.map((url, i) => (\n                      <div key={i} className=\"relative\">\n                        <img src={url} alt=\"Floor Plan\" className=\"w-full h-24 object-cover rounded\" />\n                        <button\n                          type=\"button\"\n                          onClick={() => removeFloorPlan(i)}\n                          className=\"absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs\"\n                        >\n                          ×\n                        </button>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n\n              <div className=\"flex gap-4\">\n                <Button type=\"submit\" className=\"flex-1\">\n                  {editingDevelopment ? 'Atualizar' : 'Criar'}\n                </Button>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  className=\"flex-1\"\n                  onClick={() => {\n                    setIsModalOpen(false)\n                    resetForm()\n                  }}\n                >\n                  Cancelar\n                </Button>\n              </div>\n            </form>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}
